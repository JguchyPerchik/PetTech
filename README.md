# Анализ и Оптимизация Бренд-блоков

Этот скрипт на Python (`Mr. Kranch_calc.py`) предназначен для глубокого анализа данных о заказах из файлов Excel. Его основная цель — формирование "бренд-блоков" в строгом соответствии с заданными правилами, а также оптимизация выбора этих блоков для максимизации общей прибыли. Кроме того, скрипт генерирует подробные сводные отчеты и рейтинг менеджеров, предоставляя ценную информацию для принятия бизнес-решений.

## Описание Функциональности

Скрипт `Mr. Kranch_calc.py` реализует сложную логику для выполнения следующих ключевых задач:

1.  **Чтение и Валидация Данных:**
    *   Скрипт считывает исходные данные о заказах из входного файла Excel, расположенного по пути `src/Mr. Kranch.xlsx`.
    *   Выполняется нормализация числовых значений в колонках "Amount" и "Price", заменяя запятые на точки для корректной обработки чисел с плавающей точкой.
    *   Производится тщательная валидация структуры DataFrame: проверяется наличие всех обязательных колонок (`Manager`, `Contract_ID`, `Order`, `Category`, `Nomenclature_ID`, `Quantity`, `Amount`, `Price`) и корректность типов данных для числовых колонок (`Quantity`, `Amount`, `Price`). В случае обнаружения ошибок вызывается `ValueError` или `TypeError`.

2.  **Определение Бренд-блоков (`block_rules`):**
    *   В начале скрипта определен словарь `block_rules`, который содержит правила для формирования различных типов бренд-блоков.
    *   Каждый тип блока (например, "Discovery", "Happy Launch", "Play") имеет свои требования к количеству уникальных SKU (Stock Keeping Units) "игрушек" и "мисок". Например, блок "Discovery" требует 25 уникальных SKU игрушек и 15 уникальных SKU мисок. Эти правила являются основой для алгоритма формирования блоков.

3.  **Оптимизация Выбора Бренд-блоков (Рекурсивный Подход):**
    *   Центральная часть логики скрипта реализована в функции `get_all_brand_blocks`, которая использует рекурсивный алгоритм с бэктрекингом для исследования всех возможных комбинаций бренд-блоков.
    *   **Цель Оптимизации:** Главная цель — максимизировать **общую прибыль** от всех сформированных блоков. Если несколько комбинаций дают одинаковую максимальную прибыль, скрипт выбирает ту, которая также максимизирует **общее количество** сформированных блоков.
    *   **Приоритет SKU:** При выборе конкретных SKU для формирования каждого блока учитываются следующие приоритеты:
        1.  SKU с наибольшим оставшимся количеством (`remaining_quantity`).
        2.  SKU с наибольшей ценой (`Price`) (при равном оставшемся количестве).
    *   **Функция `find_block_set_details`:** Вспомогательная функция, которая определяет оптимальное значение `k` (минимальное количество единиц на SKU, необходимое для формирования одного набора уникальных SKU для блока) и выбирает конкретные SKU на основе вышеуказанных приоритетов.

4.  **Основной Pipeline (`process_file`):**
    *   Функция `process_file` orchestrates весь процесс обработки данных.
    *   Она группирует данные по менеджеру, идентификатору контракта и номеру заказа, а затем применяет функцию `count_brand_blocks` к каждой группе для подсчета бренд-блоков.
    *   Выбранные элементы для блоков используются для расчета `Block_Amount` (прибыли от каждого блока) и `Sales_sum` (общей суммы продаж).

5.  **Генерация Отчетов и Рейтинга:**
    *   Скрипт создает выходной файл Excel (`Mr. Kranch_calc.xlsx`) с тремя специализированными листами:
        *   `full`: Содержит подробную информацию о каждом заказе, включая подсчет сформированных бренд-блоков.
        *   `summary`: Представляет собой сводный отчет по каждому менеджеру, детализирующий общую сумму продаж (прибыль от блоков) и количество контрактов, в которых были сформированы блоки.
        *   `ranking`: Генерирует рейтинг менеджеров на основе трех критериев: общая сумма продаж, количество контрактов с блоками и общее количество блоков. Менеджеры ранжируются по сумме этих рангов, где меньший итоговый балл означает более высокий рейтинг.

## Правила Бренд-блоков (`block_rules`)

В словаре `block_rules` определены следующие типы бренд-блоков и их состав:

*   **"Discovery"**: Требует 25 уникальных SKU игрушек и 15 уникальных SKU мисок.
*   **"Happy Launch"**: Требует 20 уникальных SKU игрушек и 0 уникальных SKU мисок.
*   **"Play"**: Требует 40 уникальных SKU игрушек и 0 уникальных SKU мисок.

## Приоритет Блоков при Оптимизации

При поиске оптимальной комбинации блоков, если несколько вариантов дают **одинаковую максимальную прибыль** и **одинаковое максимальное количество блоков**, блоки рассматриваются в следующем порядке приоритета для разрешения таких коллизий (от высшего к низшему):

1.  **PLAY**
2.  **DISCOVERY**
3.  **HAPPY LAUNCH**

## Использование

### Зависимости

Для корректной работы скрипта `Mr. Kranch_calc.py` требуются следующие библиотеки Python. Рекомендуется установить их в виртуальное окружение:

*   `pandas`: Мощная библиотека для анализа и манипулирования данными.
*   `openpyxl`: Используется для чтения и записи файлов Excel (`.xlsx`).
*   `XlsxWriter`: Бэкенд для `pandas.ExcelWriter` для записи файлов Excel.
*   `ipython`: Используется для функции `display`.

Вы можете легко установить все необходимые зависимости, используя `pip` и предоставленный файл `requirements.txt`:

```bash
pip install -r README/requirements.txt
```

### Запуск Скрипта

Для запуска скрипта `Mr. Kranch_calc.py` выполните следующую команду в терминале. Убедитесь, что вы находитесь в корневой директории проекта:

```bash
python Mr. Kranch_calc.py
```

*   **Входной файл:** Скрипт по умолчанию ожидает входной файл `src/Mr. Kranch.xlsx`. Убедитесь, что этот файл существует и имеет корректную структуру.
*   **Выходной файл:** Результаты обработки будут сохранены в новый файл `Mr. Kranch_calc.xlsx` в корневой директории проекта.
